{% extends 'base.html' %}
{% load typogrify %}
{% load custom_html %}
{% load navigation %}
{% load sidebartags %}
{% load polls %}
{% load flash %}
{% load lists %}

{% block head-code %}<link rel="alternate" type="application/rss+xml" title="Latest stories feed (RSS 2.0)" href="/rss/latest/" />{% endblock head-code %}

{% block title %}{{ config.issue.pub_date|date:"F j, Y" }} - {{ block.super }}{% endblock title %}

{% block header-type %}primary{% endblock header-type %}
	{% block header-img %}logo_front.gif{% endblock header-img %}
	{% block dateline %}{{ config.issue.pub_date|date:"F j, Y" }}{% endblock dateline %}
	{% block issueline %}Vol. {{ config.issue.volume.volume}}, Issue {{ config.issue.issue }}{% endblock issueline %}

{% block menu-type %}narrow{% endblock menu-type %}

{% block layout-type %}wide-2cols{% endblock layout-type %}
	{% block breadcrumb %}
		<a href="{% url journal.stories.views.index_front config.issue.pub_date %}">{% current_issue as issue %}{% ifequal issue.pub_date config.issue.pub_date %}Current issue{% else %}Back issue{% endifequal %}</a> &raquo; Front page
	{% endblock breadcrumb %}
	{% block actions %}
		<div id="actions"><p><span id="actions-rss" class="action"><a href="/rss/latest/">Latest stories RSS <img src="/media/global/icon_rss.gif" /></a></span></p></div>
	{% endblock actions %}
	{% block issue-banner %}
		{% if config.issue.extra %}
			<div id="issue-banner" class="clearfix">
				<h1>{{ config.issue.extra }}</h1><h4>A special issue of the Journal</h4>
			</div>
		{% endif %}
	{% endblock issue-banner %}
	{% block content %}
		<div id="topstory" class="story clearfix">
			{% if story.photo %}
				<div id="standalonephoto" class="clearfix">
				<h4 id="standalonephoto-head">{{ story.photohead|stripspace|widont }}</h4>
				<img src="{{ story.photo.get_photo_url }}" class="story-photo" />
				<p class="story-caption">{{ story.photo.caption }}{% ifnotequal story.photo.list_photographer '[no credit]' %} ({{ story.photo.list_photographer }}){% endifnotequal %}</p>
				</div>
			{% else %}
				{% if story.story.storyphoto_set.all %}
					{% for pwrapper in story.story.storyphoto_set.all %}
						{% if forloop.first %}
						<img src="{{ pwrapper.photo.get_photo_url }}" class="story-photo" />
						<p class="story-caption">{{ pwrapper.photo.caption }}{% ifnotequal pwrapper.photo.list_photographer '[no credit]' %} ({{ pwrapper.photo.list_photographer }}){% endifnotequal %}</p>
						{% endif %}
					{% endfor %}
				{% endif %}
			{% endif %}
			<p class="story-label">{% firstof story.story.label "Top Story" %}</p>
			<h2 class="story-head"><a href="{{ story.story.get_absolute_url }}">{{ story.story.head|stripspace|convert_entities }}</a></h2>
			<p class="story-summary">{{ story.story.summary|stripspace|convert_entities|widont }}</p>
		</div>
		<div id="stories-other">
			{% for otherstory in config.frontpagefirsttierstory_set.all %}
				<p class="story-label">{% firstof otherstory.label otherstory.story.label "Story" %}</p>
				<h3 class="otherstory-head"><a href="{{ otherstory.story.get_absolute_url }}">{{ otherstory.story.head|stripspace|convert_entities|widont }}</a></h3>
				<p class="otherstory-summary">{{ otherstory.story.summary|stripspace|convert_entities|widont }}</p>
			{% endfor %}
			{% if config.frontpagesecondtierstory_set.all %}
				<p class="story-label">Other stories</p>
				{% for otherstory in config.frontpagesecondtierstory_set.all %}
					<h4 class="otherstory-head"><a href="{{ otherstory.story.get_absolute_url }}">{{ otherstory.story.head|stripspace|convert_entities|widont }}</a></h4>
				{% endfor %}
			{% endif %}
		</div>
		<div id="content-sidebar">
			{% if config.announce_head and config.announce_body %}
			<div class="announcement">
				<h4>{{ config.announce_head|stripspace|convert_entities|widont }}</h4>
				{{ config.announce_body|linebreaks|convert_entities|typogrify }}
			</div>
			{% endif %}
			{% front_sidebar %}
		</div>
	{% endblock content %}

	{% block poll %}
	{% if config.poll %}
		<div id="menu-poll" class="poll">
			<p class="menu-label">Poll</p>
			<p id="poll-question">{{ config.poll.question }}</p>
			{% pollflash config.poll.id %}
				{% ifequal pollmsg.params.type 'voteflood' %}{% ifequal pollmsg.poll config.poll.id %}<p><strong>{{ pollmsg.msg }}</strong></p>{% endifequal %}{% endifequal %}
			{% endpollflash %}
			{% if config.poll.id|in_list:request.session.vote or request.GET.results or not config.poll.is_active %}
			{% if not config.poll.is_active %}
				<p><strong>Voting on this poll is closed.</strong></p>
			{% endif %}
			<ul id="poll-results">
				{% for choice in config.poll.choice_set.all %}
				<li class="clearfix"><p>{{ choice.choice }}</p>
				<p class="result-number">{{ choice.vote_set.count }}</p>
				<div class="result-bar-back">
					<div class="result-bar-interval"></div>
					<div class="result-bar-interval"></div>
					<div class="result-bar-interval"></div>
					<div class="result-bar-interval"></div>
				{% ifnotequal choice.vote_set.count 0 %}
					<div class="result-bar" style="width: {% widthratio choice.vote_set.count config.poll.total_votes 118 %}px;"></div>
				{% endifnotequal %}
				</div>
				</li>
				{% endfor %}
			{% else %}
			<form action="{% url journal.polls.views.poll_vote config.poll.id %}" method="post">
				{% poll_form config.poll.id as form %}
				{{ form.choice }}
				<input type="hidden" name="url" value="{{ request.get_full_path }}" />
				<button type="submit">Vote!</button> <a href="{{ request.get_full_path }}?results=1">View results</a>
			</form>
			{% endif %}
		</div>
	{% endif %}
	{% endblock poll %}
	
